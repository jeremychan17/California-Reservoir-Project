---
title: "Reservoir_v3"
author: "Jeremy Chan"
date: "April 21, 2016"
output: html_document
---
Questions to ask (4/27):
Better imputation methods?
Impute mulptile NAs
Final report format
For every NA value, pull daily data and form average?
Converting x-axis into time -email Duncan + data/code and report guidelines

Questions for Patrick
review forecasting code
is d necessary in auto.arima
should I be forecasting raw reservoir levels or capacities?

Libraries
```{r}
library(sharpshootR)
library(XML)
library(gdata)
```

List of major reservoirs | Reservoir ID:

Trinity Lake | CLE
Lake Shasta | SHA
Lake Oroville | ORO
New Melones | NML
Folsom Lake | FOL
Don Pedro | DNP
Exchequer | EXC
San Luis | SNL
Millerton Lake | MIL
Pine Flat | PNF
Castaic Lake | CAS
Lake Perris | PRR

Data Retrieval
```{r}

# List of reservoirs of interest, monthly intervals
# resList = c("CLE", "SHA", "ORO", "NML", "FOL", "DNP", "EXC", "SNL", "MIL", "PNF", "CAS", "PRR")
# EXC is not working
resList = c("CLE", "SHA", "ORO", "NML", "FOL", "DNP", "SNL", "MIL", "PNF", "CAS", "PRR")
# resData = lapply(resList, function(x) CDECquery(x, 15, interval = "M", "1900-01-01", Sys.Date()))
resData = lapply(resList, function(x) CDECquery(x, 15, interval = "M", "1900-01-01", "2016-04-30"))

# Capacity table
u = "http://cdec.water.ca.gov/misc/resinfo.html" # Reservoir URL
table = readHTMLTable(u)[1] # Pulls Reservoir Table 
table = table[[1]] # Takes first Column
names(table) = c("ID", "Dam", "Lake", "Stream", "Capacity") # Renames Columns of Table
capacityList = table$Capacity # Pulls List of all Capacities
positions = sapply(1:length(resList), function(x) grep(resList[x], table$ID)) # Obtains positions of all reservoirs of interest
finalCapList = capacityList[c(positions)] # List of capacities from reservoirs of interest
finalCapList = as.numeric(gsub(",", "", finalCapList)) # Turns list into numerics

# Adds Capacity and computes capacity for each reservoir
for(i in 1:length(resList))
{
  resData[[i]]$ID = resList[[i]] #adds ID Column
  resData[[i]]$cap = (resData[[i]]$value/finalCapList[[i]])*100 #Computes capacity %
}

keep(resData, forecast.all, sure = T)
```

Plotting
```{r}
plot(resData[[1]]$datetime, resData[[1]]$cap, type = "l", main = "Trinity Lake (CLE)", 
     ylab = "Capacity (Percentage)", xlab = "Date (Year)")
plot(resData[[2]]$datetime, resData[[2]]$cap, type = "l", main = "Lake Shasta (SHA)", 
     ylab = "Capacity (Percentage)", xlab = "Date (Year)")
plot(resData[[3]]$datetime, resData[[3]]$cap, type = "l", main = "Lake Oroville (ORO)", 
     ylab = "Capacity (Percentage)", xlab = "Date (Year)")
plot(resData[[4]]$datetime, resData[[4]]$cap, type = "l", main = "New Melones (NML)", 
     ylab = "Capacity (Percentage)", xlab = "Date (Year)")
plot(resData[[5]]$datetime, resData[[5]]$cap, type = "l", main = "Folsom Lake (FOL)", 
     ylab = "Capacity (Percentage)", xlab = "Date (Year)")
plot(resData[[6]]$datetime, resData[[6]]$cap, type = "l", main = "Don Pedro (DNP)", 
     ylab = "Capacity (Percentage)", xlab = "Date (Year)")
plot(resData[[7]]$datetime, resData[[7]]$cap, type = "l", main = "San Luis (SNL)", 
     ylab = "Capacity (Percentage)", xlab = "Date (Year)")
plot(resData[[8]]$datetime, resData[[8]]$cap, type = "l", main = "Millerton Lake (MIL)", 
     ylab = "Capacity (Percentage)", xlab = "Date (Year)")
plot(resData[[9]]$datetime, resData[[9]]$cap, type = "l", main = "Pine Flat (PNF)", 
     ylab = "Capacity (Percentage)", xlab = "Date (Year)") 
plot(resData[[10]]$datetime, resData[[10]]$cap, type = "l", main = "Castaic Lake (CAS)", 
     ylab = "Capacity (Percentage)", xlab = "Date (Year)")
plot(resData[[11]]$datetime, resData[[11]]$cap, type = "l", main = "Lake Perris (PRR)", 
     ylab = "Capacity (Percentage)", xlab = "Date (Year)")

plot(test$datetime, test$cap, type = "l", main = "Lake Perris (PRR)", 
     ylab = "Capacity (Percentage)", xlab = "Date (Year)")
```

Data Cleaning
```{r}
sum(is.na(resData[[1]]$cap)) # CLE no NA
sum(is.na(resData[[2]]$cap)) # SHA 2 NA
  which(is.na(resData[[2]]$cap)) # SHA 31, 196 # Far enough away that the imputation will handle
sum(is.na(resData[[3]]$cap)) # ORO no NA
sum(is.na(resData[[4]]$cap)) # NML no NA
sum(is.na(resData[[5]]$cap)) # FOL no NA
sum(is.na(resData[[6]]$cap)) # DNP no NA
sum(is.na(resData[[7]]$cap)) # SNL no NA
sum(is.na(resData[[8]]$cap)) # MIL no NA
sum(is.na(resData[[9]]$cap)) # PNF 10 NA
  which(is.na(resData[[9]]$cap)) # PNF 10, 11, 12, 13, 14, 15, 16, 21, 22, 322
sum(is.na(resData[[10]]$cap)) # CAS 1 NA
  which(is.na(resData[[10]]$cap)) # CAS 48 # Imputation will handle
sum(is.na(resData[[11]]$cap)) # PRR 1 NA
  which(is.na(resData[[11]]$cap)) # PRR 48 # Imputation will handle
  
# Cleaning PNF
resData[[9]][10:22,]
# PNF_temp = CDECquery("PNF", 15, interval = "D", "1952-09-01", "1953-10-01") # no daily data, use hist average for that month
monthList = levels(as.factor(resData[[9]]$month)) # List of Months
histMeanVector = 0 # Empty Vector
for(i in 1:length(monthList)) # Creates historical mean vector
  {
    histMeanVector[i] = mean(subset(resData[[9]], month == monthList[i])$cap, na.rm = TRUE)
}

naList = which(is.na(resData[[9]]$cap))

for(i in 1:(length(naList)-1))
{
  month = resData[[9]][naList[i],]$month
  meanIndex = grep(resData[[9]][naList[i],]$month, monthList)
  resData[[9]][naList[i],]$cap = histMeanVector[i]
}
# Fixes all but 322

# Cleaning PRR
# Drop stabilizes at 378
# Drop all observations before 378
resData[[11]] = resData[[11]][378:length(resData[[11]]$cap),]

```

Forecasting
```{r}
forc_CLE = forecast.all(resData[[1]])
forc_SHA = forecast.all(resData[[2]])
forc_ORO = forecast.all(resData[[3]])
forc_NML = forecast.all(resData[[4]])
forc_FOL = forecast.all(resData[[5]])
forc_DNP = forecast.all(resData[[6]])
forc_SNL = forecast.all(resData[[7]])
forc_MIL = forecast.all(resData[[8]])
forc_PNF = forecast.all(resData[[9]]) # Being weird, missing multiple NAs
forc_CAS = forecast.all(resData[[10]])
forc_PRR = forecast.all(resData[[11]])
```
